import React, { useState, useEffect } from 'react';
import { Search, MapPin, Wind, Droplets, Thermometer, Cloud, Sun, CloudRain, CloudSnow, CloudLightning, Calendar } from 'lucide-react';

export default function WeatherApp() {
  const [query, setQuery] = useState('Taipei');
  const [weatherData, setWeatherData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // WMO Weather interpretation codes (WW)
  const getWeatherIcon = (code) => {
    if (code === 0) return <Sun className="w-16 h-16 text-yellow-400" />;
    if (code >= 1 && code <= 3) return <Cloud className="w-16 h-16 text-gray-400" />;
    if (code >= 45 && code <= 48) return <Cloud className="w-16 h-16 text-gray-500" />;
    if (code >= 51 && code <= 67) return <CloudRain className="w-16 h-16 text-blue-400" />;
    if (code >= 71 && code <= 77) return <CloudSnow className="w-16 h-16 text-blue-200" />;
    if (code >= 80 && code <= 82) return <CloudRain className="w-16 h-16 text-blue-600" />;
    if (code >= 95 && code <= 99) return <CloudLightning className="w-16 h-16 text-purple-500" />;
    return <Sun className="w-16 h-16 text-yellow-400" />;
  };

  const getWeatherDescription = (code) => {
    const codes = {
      0: '晴朗',
      1: '大致晴朗',
      2: '多雲',
      3: '陰天',
      45: '霧',
      48: '白霜霧',
      51: '毛毛雨 (輕微)',
      53: '毛毛雨 (中等)',
      55: '毛毛雨 (強烈)',
      61: '下雨 (小雨)',
      63: '下雨 (中雨)',
      65: '下雨 (大雨)',
      71: '降雪 (小雪)',
      73: '降雪 (中雪)',
      75: '降雪 (大雪)',
      80: '陣雨 (輕微)',
      81: '陣雨 (中等)',
      82: '陣雨 (強烈)',
      95: '雷雨',
      96: '雷雨伴隨冰雹',
      99: '強烈雷雨伴隨冰雹'
    };
    return codes[code] || '未知天氣';
  };

  const getSmallIcon = (code) => {
    if (code === 0) return <Sun className="w-8 h-8 text-yellow-500" />;
    if (code >= 1 && code <= 3) return <Cloud className="w-8 h-8 text-gray-400" />;
    if (code >= 51) return <CloudRain className="w-8 h-8 text-blue-400" />;
    return <Sun className="w-8 h-8 text-yellow-500" />;
  };

  const fetchWeather = async (searchCity) => {
    setLoading(true);
    setError(null);
    try {
      // 1. Geocoding API to get Lat/Lon
      const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${searchCity}&count=1&language=zh&format=json`;
      const geoRes = await fetch(geoUrl);
      const geoData = await geoRes.json();

      if (!geoData.results || geoData.results.length === 0) {
        throw new Error('找不到該城市，請嘗試輸入英文名稱或檢查拼寫。');
      }

      const { latitude, longitude, name, country } = geoData.results[0];

      // 2. Weather API to get forecast
      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
      
      const weatherRes = await fetch(weatherUrl);
      const weatherJson = await weatherRes.json();

      setWeatherData({
        city: name,
        country: country,
        current: weatherJson.current,
        daily: weatherJson.daily,
        currentUnits: weatherJson.current_units
      });

    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (e) => {
    e.preventDefault();
    if (query.trim()) {
      fetchWeather(query);
    }
  };

  // Initial load
  useEffect(() => {
    fetchWeather('Taipei');
  }, []);

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('zh-TW', { weekday: 'short', month: 'numeric', day: 'numeric' }).format(date);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center p-4 font-sans">
      <div className="bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row min-h-[600px]">
        
        {/* Left Panel: Search & Current Weather */}
        <div className="w-full md:w-1/3 bg-gradient-to-b from-blue-500 to-blue-700 text-white p-8 flex flex-col justify-between relative">
          
          {/* Decorative Circles */}
          <div className="absolute top-0 right-0 -mr-16 -mt-16 w-48 h-48 rounded-full bg-white/10 blur-2xl"></div>
          <div className="absolute bottom-0 left-0 -ml-16 -mb-16 w-32 h-32 rounded-full bg-white/10 blur-xl"></div>

          {/* Search Bar */}
          <div className="relative z-10 mb-8">
            <form onSubmit={handleSearch} className="flex items-center bg-white/20 rounded-full px-4 py-2 border border-white/30 focus-within:bg-white/30 transition-all">
              <Search size={20} className="text-white/80 mr-2" />
              <input 
                type="text" 
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="輸入城市 (例如: Taipei)"
                className="bg-transparent border-none outline-none text-white placeholder-white/70 w-full"
              />
            </form>
          </div>

          {/* Current Weather Content */}
          <div className="flex-grow flex flex-col items-center justify-center text-center z-10">
            {loading ? (
              <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
            ) : error ? (
              <div className="bg-red-500/80 p-4 rounded-lg text-sm">{error}</div>
            ) : weatherData ? (
              <>
                <div className="flex items-center space-x-2 text-white/90 mb-2">
                  <MapPin size={20} />
                  <span className="text-lg font-medium tracking-wide">{weatherData.city}, {weatherData.country}</span>
                </div>
                
                <div className="my-6 transform hover:scale-105 transition-transform duration-300">
                  {getWeatherIcon(weatherData.current.weather_code)}
                </div>

                <h1 className="text-7xl font-bold mb-2">
                  {Math.round(weatherData.current.temperature_2m)}°
                </h1>
                <p className="text-xl font-light text-blue-100 mb-6">
                  {getWeatherDescription(weatherData.current.weather_code)}
                </p>
                
                <div className="w-full h-px bg-white/20 mb-6"></div>

                <div className="grid grid-cols-2 gap-4 w-full text-sm">
                  <div className="flex flex-col items-center p-2 bg-white/10 rounded-xl">
                    <Droplets size={20} className="mb-1 text-blue-200" />
                    <span className="text-white/70">濕度</span>
                    <span className="font-semibold">{weatherData.current.relative_humidity_2m}%</span>
                  </div>
                  <div className="flex flex-col items-center p-2 bg-white/10 rounded-xl">
                    <Wind size={20} className="mb-1 text-blue-200" />
                    <span className="text-white/70">風速</span>
                    <span className="font-semibold">{weatherData.current.wind_speed_10m} km/h</span>
                  </div>
                </div>
              </>
            ) : null}
          </div>
          
          <div className="text-center text-xs text-blue-200 mt-6 z-10">
            Powered by Open-Meteo
          </div>
        </div>

        {/* Right Panel: Details & Forecast */}
        <div className="w-full md:w-2/3 p-8 bg-gray-50 flex flex-col">
          <div className="mb-6 flex items-center justify-between">
            <h2 className="text-2xl font-bold text-gray-800">未來預報</h2>
            <div className="flex space-x-2">
              <span className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center cursor-pointer hover:bg-gray-300 transition-colors">C</span>
            </div>
          </div>

          {loading ? (
            <div className="flex-grow flex items-center justify-center">
              <div className="text-gray-400">載入預報中...</div>
            </div>
          ) : weatherData && weatherData.daily ? (
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
              {weatherData.daily.time.slice(0, 6).map((time, index) => (
                <div key={time} className="bg-white p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 flex flex-col items-center justify-between h-32">
                  <span className="text-sm font-medium text-gray-500">
                    {index === 0 ? '今天' : formatDate(time)}
                  </span>
                  
                  <div className="my-1">
                    {getSmallIcon(weatherData.daily.weather_code[index])}
                  </div>
                  
                  <div className="flex space-x-3 w-full justify-center">
                    <span className="text-gray-800 font-bold">{Math.round(weatherData.daily.temperature_2m_max[index])}°</span>
                    <span className="text-gray-400 font-medium">{Math.round(weatherData.daily.temperature_2m_min[index])}°</span>
                  </div>
                </div>
              ))}
            </div>
          ) : null}

          {/* Highlights Section */}
          {weatherData && (
            <div className="mt-8">
              <h3 className="text-xl font-bold text-gray-800 mb-4">今日詳細資訊</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center space-x-4">
                  <div className="bg-orange-100 p-3 rounded-full text-orange-500">
                    <Thermometer size={24} />
                  </div>
                  <div>
                    <p className="text-gray-500 text-sm">體感溫度</p>
                    <p className="text-xl font-bold text-gray-800">{Math.round(weatherData.current.apparent_temperature)}°</p>
                  </div>
                </div>
                
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center space-x-4">
                  <div className="bg-blue-100 p-3 rounded-full text-blue-500">
                    <Calendar size={24} />
                  </div>
                  <div>
                    <p className="text-gray-500 text-sm">日期</p>
                    <p className="text-xl font-bold text-gray-800">{new Date().toLocaleDateString('zh-TW')}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
